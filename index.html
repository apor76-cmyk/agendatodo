<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Agenda + Todo Manager FINAL</title>

<style>
:root{
  --bg:#f3f4f6;
  --card:#ffffff;
  --text:#111827;
  --sub:#6b7280;
  --border:#e5e7eb;
  --accent:#2563eb;
}
.dark{
  --bg:#0b1220;
  --card:#111827;
  --text:#e5e7eb;
  --sub:#9ca3af;
  --border:#1f2937;
  --accent:#3b82f6;
}
*{box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto}
body{margin:0;background:var(--bg);color:var(--text)}
header{display:flex;gap:8px;padding:12px;border-bottom:1px solid var(--border);background:var(--card);position:sticky;top:0;z-index:10;flex-wrap:wrap}
button{border:1px solid var(--border);background:var(--card);color:var(--text);padding:8px 12px;border-radius:8px;cursor:pointer;white-space:nowrap}
button.active{background:var(--accent);color:#fff;border-color:var(--accent)}
input,select,textarea{border:1px solid var(--border);background:var(--card);color:var(--text);padding:8px;border-radius:8px;width:100%}
.container{max-width:1100px;margin:auto;padding:16px;display:flex;flex-direction:column;gap:12px}
.card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px}
.row{display:flex;gap:8px;flex-wrap:wrap}
.todo-item{display:flex;gap:4px;align-items:center;margin-left:auto}
.done{opacity:.5;text-decoration:line-through}
.search{flex:1}
.right{margin-left:auto}
.small{font-size:12px;color:var(--sub)}
.pinned{border:2px solid var(--accent)}
.category-bar{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:6px}
.category-pill{padding:6px 10px;border-radius:999px;border:1px solid var(--border);cursor:pointer}
.category-pill.active{background:var(--accent);color:#fff;border-color:var(--accent)}
.prio-high{color:#ef4444;font-weight:600}
.prio-mid{color:#f59e0b;font-weight:600}
.prio-low{color:#10b981;font-weight:600}
.todo-text{writing-mode:horizontal-tb;word-break:keep-all;white-space:normal}
.todo-check{ width:16px; height:16px; }
</style>
</head>

<body>

<header>
<button id="tabAgenda">ì•ˆê±´ê´€ë¦¬</button>
<button id="tabTodo">í• ì¼ê´€ë¦¬</button>
<input class="search" id="search" placeholder="ì „ì²´ ê²€ìƒ‰">

<button id="backupBtn">ë°±ì—…</button>
<button id="restoreBtn">ë³µì›</button>

<!-- GitHub Sync ë²„íŠ¼ -->
<button id="ghPush">ì—…ë¡œë“œ</button>
<button id="ghPull">ë‚´ë ¤ë°›ê¸°</button>
<button id="ghTokenReset">í† í°ì´ˆê¸°í™”</button>

<!-- ì „ì²´ ì‚­ì œ ë²„íŠ¼ -->
<button id="clearAll">ì „ì²´ ì‚­ì œ</button>

<input type="file" id="fileInput" hidden>
<button id="toggleDark" class="right">ë‹¤í¬ëª¨ë“œ</button>
</header>

<div class="container" id="app"></div>

<script>
/* ===== ë¹„ë°€ë²ˆí˜¸ ê´€ë¦¬ ===== */
const PW_KEY = "agenda_pw"
if(!localStorage.getItem(PW_KEY)) localStorage.setItem(PW_KEY, "1234") // ì´ˆê¸° ë¹„ë°€ë²ˆí˜¸

function checkPassword(promptText="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥") {
  const pw = prompt(promptText)
  if(pw===null) return false
  const saved=localStorage.getItem(PW_KEY)
  if(pw===saved) return true
  alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë¦½ë‹ˆë‹¤")
  return false
}

function changePassword(){
  if(!checkPassword("ê¸°ì¡´ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥")) return
  const newPw = prompt("ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥")
  if(!newPw) return alert("ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤")
  localStorage.setItem(PW_KEY,newPw)
  alert("ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤")
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ë¹„ë°€ë²ˆí˜¸ í™•ì¸
window.addEventListener("load",()=>{
  if(!checkPassword("ì•± ì ‘ê·¼ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥")){
    document.body.innerHTML="<h2 style='text-align:center;margin-top:50px'>ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¤ ì•±ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤</h2>"
    throw new Error("ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜ë¡œ ì•± ì¢…ë£Œ")
  }
})

/* ===== ê¸°ì¡´ Agenda+Todo ì½”ë“œ ===== */
const storageKey="agendaTodoUltimate"

let data=JSON.parse(localStorage.getItem(storageKey)||`{"agendas":[],"todos":[],"categories":[],"selectedCategory":null,"lastTab":"agenda"}`)
if(!data.categories) data.categories=[]
if(data.selectedCategory===undefined) data.selectedCategory=null

let editingIndex=null
let editingTodoIndex=null
let dragType=null
let dragIndex=null

function save(){ localStorage.setItem(storageKey,JSON.stringify(data)) }
function el(tag,cls){ const e=document.createElement(tag); if(cls)e.className=cls; return e }

const app=document.getElementById("app")
const tabAgenda=document.getElementById("tabAgenda")
const tabTodo=document.getElementById("tabTodo")
const searchInput=document.getElementById("search")
const backupBtn=document.getElementById("backupBtn")
const restoreBtn=document.getElementById("restoreBtn")
const fileInput=document.getElementById("fileInput")
const toggleDark=document.getElementById("toggleDark")
const ghPush=document.getElementById("ghPush")
const ghPull=document.getElementById("ghPull")
const ghTokenReset=document.getElementById("ghTokenReset")
const clearAll=document.getElementById("clearAll")

tabAgenda.onclick=()=>setTab("agenda")
tabTodo.onclick=()=>setTab("todo")
function setTab(tab){ data.lastTab=tab; save(); render() }

function handleDragStart(type,index){ dragType=type; dragIndex=index }
function handleDragOver(e){ e.preventDefault() }
function handleDrop(type,index){
 if(dragType!==type || dragIndex===index) return
 const list=type==="agenda"?data.agendas:data.todos
 const item=list.splice(dragIndex,1)[0]
 list.splice(index,0,item)
 dragIndex=null; dragType=null
 save(); render()
}

function render(){
 app.innerHTML=""
 tabAgenda.classList.toggle("active",data.lastTab==="agenda")
 tabTodo.classList.toggle("active",data.lastTab==="todo")
 if(data.lastTab==="agenda") renderAgenda()
 else renderTodo()
}

/* ===== ì¹´í…Œê³ ë¦¬ ===== */
function renderCategoryTabs(){
 const bar=el("div","category-bar")
 const list = data.lastTab==="agenda" ? data.agendas : data.todos
 const totalCount = list.length
 const all=el("div","category-pill "+(data.selectedCategory===null?"active":""))
 all.textContent=`ì „ì²´ (${totalCount})`
 all.onclick=()=>{data.selectedCategory=null;save();render()}
 bar.appendChild(all)

 data.categories.forEach((c,i)=>{
   const count = list.filter(item=>item.category===i).length
   const pill=el("div","category-pill "+(data.selectedCategory===i?"active":""))
   pill.textContent=`${c.name} (${count})`
   pill.onclick=()=>{data.selectedCategory=i;save();render()}
   bar.appendChild(pill)
 })
 return bar
}

function renderCategoryManager(){
 const card=el("div","card")
 card.innerHTML=`
 <div class="row">
   <select id="catSelect" style="max-width:200px">
     <option value="">ì„ íƒ</option>
     ${data.categories.map((c,i)=>`<option value="${i}">${c.name}</option>`).join("")}
   </select>
   <input id="catEditName" placeholder="ì´ë¦„ ìˆ˜ì •" style="max-width:200px">
   <button onclick="applyCategoryEdit()">ì ìš©</button>
   <button onclick="deleteSelectedCategory()">ì‚­ì œ</button>
   <input id="catName" placeholder="ìƒˆ ì¹´í…Œê³ ë¦¬" style="max-width:200px">
   <button onclick="addCategory()">ì¶”ê°€</button>
 </div>`
 return card
}

function applyCategoryEdit(){
 const i=document.getElementById("catSelect").value
 const name=document.getElementById("catEditName").value.trim()
 if(i===""||!name) return
 data.categories[i].name=name
 save(); render()
}
function deleteSelectedCategory(){
 const i=document.getElementById("catSelect").value
 if(i==="") return
 if(!confirm("ì‚­ì œí• ê¹Œìš”?")) return
 data.categories.splice(i,1)
 data.agendas.forEach(a=>{ if(a.category==i) a.category=null })
 data.todos.forEach(t=>{ if(t.category==i) t.category=null })
 data.selectedCategory=null
 save(); render()
}
function addCategory(){
 const name=catName.value.trim()
 if(!name) return
 data.categories.push({name})
 save(); render()
}

/* ===== ì•ˆê±´ ===== */
function renderAgenda(){
 app.appendChild(renderCategoryTabs())
 app.appendChild(renderCategoryManager())

 const addCard=el("div","card")
 addCard.innerHTML=`
 <div class="row">
   <input id="agTitle" placeholder="ì•ˆê±´ ì œëª©">
   <select id="agCategory">
     <option value="">ì¹´í…Œê³ ë¦¬ ì—†ìŒ</option>
     ${data.categories.map((c,i)=>`<option value="${i}">${c.name}</option>`).join("")}
   </select>
   <select id="agColor">
     <option value="">ê¸°ë³¸</option>
     <option value="#ef4444">ë¹¨ê°•</option>
     <option value="#f97316">ì£¼í™©</option>
     <option value="#eab308">ë…¸ë‘</option>
     <option value="#22c55e">ì´ˆë¡</option>
     <option value="#3b82f6">íŒŒë‘</option>
     <option value="#6366f1">ë‚¨ìƒ‰</option>
     <option value="#a855f7">ë³´ë¼</option>
   </select>
   <button onclick="addAgenda()">ì¶”ê°€</button>
 </div>`
 app.appendChild(addCard)

 let agendas=[...data.agendas]
 agendas.sort((a,b)=>(b.pinned||0)-(a.pinned||0))

 agendas
 .filter(a=> data.selectedCategory===null || a.category===data.selectedCategory)
 .filter(a=>filterText(a.title+a.status+a.opinion+a.review+a.progress))
 .forEach(a=>{
  const i=data.agendas.indexOf(a)
  const c=el("div","card "+(a.pinned?"pinned":""))
  c.draggable=true
  c.ondragstart=()=>handleDragStart("agenda",i)
  c.ondragover=handleDragOver
  c.ondrop=()=>handleDrop("agenda",i)

  if(editingIndex===i){
    c.innerHTML=`
<input id="editTitle" value="${a.title||""}">
<select id="editCategory">
  <option value="">ì¹´í…Œê³ ë¦¬ ì—†ìŒ</option>
  ${data.categories.map((c,ci)=>`<option value="${ci}" ${a.category===ci?"selected":""}>${c.name}</option>`).join("")}
</select>
<select id="editColor">
  <option value="">ê¸°ë³¸</option>
  <option value="#ef4444" ${a.color=="#ef4444"?"selected":""}>ë¹¨ê°•</option>
  <option value="#f97316" ${a.color=="#f97316"?"selected":""}>ì£¼í™©</option>
  <option value="#eab308" ${a.color=="#eab308"?"selected":""}>ë…¸ë‘</option>
  <option value="#22c55e" ${a.color=="#22c55e"?"selected":""}>ì´ˆë¡</option>
  <option value="#3b82f6" ${a.color=="#3b82f6"?"selected":""}>íŒŒë‘</option>
  <option value="#6366f1" ${a.color=="#6366f1"?"selected":""}>ë‚¨ìƒ‰</option>
  <option value="#a855f7" ${a.color=="#a855f7"?"selected":""}>ë³´ë¼</option>
</select>
<textarea id="editStatus">${a.status||""}</textarea>
<textarea id="editOpinion">${a.opinion||""}</textarea>
<textarea id="editReview">${a.review||""}</textarea>
<textarea id="editProgress">${a.progress||""}</textarea>
<div class="row">
<button onclick="saveEdit(${i})">ì €ì¥</button>
<button onclick="cancelEdit()">ì·¨ì†Œ</button>
<button onclick="togglePin(${i})">${a.pinned?"í•€í•´ì œ":"ì¤‘ìš”ê³ ì •"}</button>
<button onclick="deleteAgenda(${i})">ì‚­ì œ</button>
</div>`
  }else{
    c.innerHTML=`
<b style="color:${a.color||'inherit'}">${a.title} ${a.pinned?"ğŸ“Œ":""}</b>
<div class="small">í˜„í™©</div><div>${a.status||""}</div>
<div class="small">ì˜ê²¬</div><div>${a.opinion||""}</div>
<div class="small">ê²€í† </div><div>${a.review||""}</div>
<div class="small">ê²½ê³¼</div><div>${a.progress||""}</div>
<div class="row">
<button onclick="startEdit(${i})">ìˆ˜ì •</button>
<button onclick="togglePin(${i})">${a.pinned?"í•€í•´ì œ":"ì¤‘ìš”ê³ ì •"}</button>
<button onclick="deleteAgenda(${i})">ì‚­ì œ</button>
</div>`
  }
  app.appendChild(c)
 })
}

function addAgenda(){
 const t=agTitle.value.trim()
 if(!t) return
 data.agendas.unshift({title:t,category: agCategory.value===""?null:Number(agCategory.value),color: agColor.value || "",status:"",opinion:"",review:"",progress:"",pinned:false})
 save(); render()
}

function startEdit(i){ editingIndex=i; render() }
function cancelEdit(){ editingIndex=null; render() }
function saveEdit(i){
 const catVal=document.getElementById("editCategory").value
 data.agendas[i]={...data.agendas[i],
   title:editTitle.value,
   category: catVal===""?null:Number(catVal),
   color: document.getElementById("editColor").value || "",
   status:editStatus.value,
   opinion:editOpinion.value,
   review:editReview.value,
   progress:editProgress.value
 }
 editingIndex=null
 save(); render()
}
function togglePin(i){ data.agendas[i].pinned=!data.agendas[i].pinned; save(); render() }
function deleteAgenda(i){ if(!confirm("ì‚­ì œí• ê¹Œìš”?"))return; data.agendas.splice(i,1); save(); render() }

/* ===== TODO ===== */
function renderTodo(){
 app.appendChild(renderCategoryTabs())

 const addCard=el("div","card")
 addCard.innerHTML=`<div class="row">
 <input id="todoText" placeholder="í• ì¼ ë‚´ìš©">
 <select id="todoCategory">
  <option value="">ì¹´í…Œê³ ë¦¬ ì—†ìŒ</option>
  ${data.categories.map((c,i)=>`<option value="${i}">${c.name}</option>`).join("")}
 </select>
 <select id="todoPriority">
 <option value="high">ë†’ìŒ</option>
 <option value="mid">ë³´í†µ</option>
 <option value="low">ë‚®ìŒ</option>
 </select>
 <input type="date" id="todoDate">
 <button onclick="addTodo()">ì¶”ê°€</button></div>`
 app.appendChild(addCard)

 data.todos
 .filter(t=> data.selectedCategory===null || t.category===data.selectedCategory)
 .filter(t=>filterText(t.text))
 .forEach((t,i)=>{
  const c=el("div","card")
  c.style.display="flex"
  c.style.alignItems="center"
  c.style.gap="8px"
  c.draggable=true
  c.ondragstart=()=>handleDragStart("todo",i)
  c.ondragover=handleDragOver
  c.ondrop=()=>handleDrop("todo",i)

  const prioClass = t.priority==="high"?"prio-high":t.priority==="mid"?"prio-mid":"prio-low"

  if(editingTodoIndex===i){
    c.innerHTML=`
    <input id="editTodoText" value="${t.text}">
    <select id="editTodoCategory">
      <option value="">ì¹´í…Œê³ ë¦¬ ì—†ìŒ</option>
      ${data.categories.map((c,ci)=>`<option value="${ci}" ${t.category===ci?"selected":""}>${c.name}</option>`).join("")}
    </select>
    <button onclick="saveTodoEdit(${i})">ì €ì¥</button>
    <button onclick="cancelTodoEdit()">ì·¨ì†Œ</button>`
  }else{
    c.innerHTML=`
    <div class="todo-text" style="flex:1;text-align:left">
      <div>${t.text}</div>
      <div class="small ${prioClass}">${t.priority} | ${t.date||""}</div>
    </div>
    <div class="todo-item">
      <input class="todo-check" type="checkbox" ${t.done?"checked":""} onchange="toggleTodo(${i})">
      <button onclick="startTodoEdit(${i})">ìˆ˜ì •</button>
      <button onclick="deleteTodo(${i})">ì‚­ì œ</button>
    </div>`
  }
  if(t.done) c.classList.add("done")
  app.appendChild(c)
 })
}

function startTodoEdit(i){ editingTodoIndex=i; render() }
function cancelTodoEdit(){ editingTodoIndex=null; render() }
function saveTodoEdit(i){
 data.todos[i].text=document.getElementById("editTodoText").value
 const catVal=document.getElementById("editTodoCategory").value
 data.todos[i].category = catVal===""?null:Number(catVal)
 editingTodoIndex=null
 save(); render()
}
function addTodo(){
 const text=todoText.value.trim()
 if(!text) return
 data.todos.push({text,category: todoCategory.value===""?null:Number(todoCategory.value),priority:todoPriority.value,date:todoDate.value,done:false})
 save(); render()
}
function toggleTodo(i){
 const item=data.todos[i]
 item.done=!item.done
 if(item.done){ data.todos.splice(i,1); data.todos.push(item) }
 save(); render()
}
function deleteTodo(i){ data.todos.splice(i,1); save(); render() }

function filterText(t){
 const q=searchInput.value.toLowerCase()
 return !q || (t||"").toLowerCase().includes(q)
}
searchInput.oninput=render

toggleDark.onclick=()=>document.body.classList.toggle("dark")

backupBtn.onclick=()=>{
 const blob=new Blob([JSON.stringify(data,null,2)],{type:"application/json"})
 const a=document.createElement("a")
 a.href=URL.createObjectURL(blob)
 a.download="agenda-backup.json"
 a.click()
}
restoreBtn.onclick=()=>fileInput.click()
fileInput.onchange=e=>{
 const file=e.target.files[0]
 if(!file) return
 const reader=new FileReader()
 reader.onload=()=>{
   if(confirm("í˜„ì¬ ë°ì´í„°ë¥¼ ë®ì–´ì“¸ê¹Œìš”?")){
     data=JSON.parse(reader.result)
     save(); render()
   }
 }
 reader.readAsText(file)
}

/* GitHub Sync */
const GH_REPO="data"
const GH_OWNER="apor76-cmyk"
const GH_PATH="data/agendatodo.json"
const TOKEN_KEY="gh_token"

function getToken(){
 let t=localStorage.getItem(TOKEN_KEY)
 if(!t){
   t=prompt("GitHub Token ì…ë ¥ (repo ê¶Œí•œ)")
   if(t) localStorage.setItem(TOKEN_KEY,t)
 }
 return t
}

ghTokenReset.onclick=()=>{
 localStorage.removeItem(TOKEN_KEY)
 alert("í† í°ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤")
}

ghPush.onclick=async()=>{
 const token=getToken()
 if(!token) return

 const url=`https://api.github.com/repos/${GH_OWNER}/${GH_REPO}/contents/${GH_PATH}`

 let sha=null
 const res=await fetch(url,{headers:{Authorization:`token ${token}`}})
 if(res.ok){ const j=await res.json(); sha=j.sha }

 const body={
   message:"update agenda data",
   content:btoa(unescape(encodeURIComponent(JSON.stringify(data,null,2)))),
   sha
 }

 const r=await fetch(url,{
   method:"PUT",
   headers:{Authorization:`token ${token}`},
   body:JSON.stringify(body)
 })

 if(r.ok) alert("ì—…ë¡œë“œ ì™„ë£Œ")
 else alert("ì—…ë¡œë“œ ì‹¤íŒ¨")
}

ghPull.onclick=async()=>{
 const token=getToken()
 if(!token) return

 const url=`https://api.github.com/repos/${GH_OWNER}/${GH_REPO}/contents/${GH_PATH}`

 const res=await fetch(url,{headers:{Authorization:`token ${token}`}})
 if(!res.ok){ alert("íŒŒì¼ ì—†ìŒ"); return }

 const j=await res.json()
 const decoded=decodeURIComponent(escape(atob(j.content)))
 data=JSON.parse(decoded)
 save(); render()
 alert("ë‹¤ìš´ë¡œë“œ ì™„ë£Œ")
}

// ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ë²„íŠ¼ ì¶”ê°€
const pwBtn=document.createElement("button")
pwBtn.textContent="ë¹„ë°€ë²ˆí˜¸ ë³€ê²½"
pwBtn.onclick=changePassword
document.querySelector("header").appendChild(pwBtn)

// ===== ì „ì²´ ì‚­ì œ ê¸°ëŠ¥ =====
clearAll.onclick = () => {
  if(confirm("ì •ë§ ì•ˆê±´ê³¼ í• ì¼ì„ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")){
    data.agendas=[]
    data.todos=[]
    save(); render()
  }
}

render()
</script>
</body>
</html>


