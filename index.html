<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Agenda + Todo Manager FINAL</title>

<style>
:root{
  --bg:#f3f4f6;
  --card:#ffffff;
  --text:#111827;
  --sub:#6b7280;
  --border:#e5e7eb;
  --accent:#2563eb;
}
.dark{
  --bg:#0b1220;
  --card:#111827;
  --text:#e5e7eb;
  --sub:#9ca3af;
  --border:#1f2937;
  --accent:#3b82f6;
}
*{box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto}
body{margin:0;background:var(--bg);color:var(--text)}
header{display:flex;gap:8px;padding:12px;border-bottom:1px solid var(--border);background:var(--card);position:sticky;top:0;z-index:10;flex-wrap:wrap}
button{border:1px solid var(--border);background:var(--card);color:var(--text);padding:8px 12px;border-radius:8px;cursor:pointer;white-space:nowrap}
button.active{background:var(--accent);color:#fff;border-color:var(--accent)}
input,select,textarea{border:1px solid var(--border);background:var(--card);color:var(--text);padding:8px;border-radius:8px;width:100%}
.container{max-width:1100px;margin:auto;padding:16px;display:flex;flex-direction:column;gap:12px}
.card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px}
.row{display:flex;gap:8px;flex-wrap:wrap}
.todo-item{display:flex;gap:4px;align-items:center;margin-left:auto}
.done{opacity:.5;text-decoration:line-through}
.search{flex:1}
.right{margin-left:auto}
.small{font-size:12px;color:var(--sub)}
.pinned{border:2px solid var(--accent)}
.category-bar{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:6px}
.category-pill{padding:6px 10px;border-radius:999px;border:1px solid var(--border);cursor:pointer}
.category-pill.active{background:var(--accent);color:#fff;border-color:var(--accent)}
.prio-high{color:#ef4444;font-weight:600}
.prio-mid{color:#f59e0b;font-weight:600}
.prio-low{color:#10b981;font-weight:600}
.todo-text{writing-mode:horizontal-tb;word-break:keep-all;white-space:normal}
.todo-check{ width:16px; height:16px; }

/* 비밀번호 모달 */
#pwModal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;
  background:rgba(0,0,0,0.5);justify-content:center;align-items:center;z-index:1000;}
#pwModal div{background:var(--card);padding:24px;border-radius:12px;max-width:300px;width:90%;
display:flex;flex-direction:column;gap:12px;}
#pwModal div div{margin-bottom:4px;font-weight:600;}
#pwModal input{width:100%;padding:8px;border-radius:8px;border:1px solid var(--border);}
#pwModal button{padding:6px 12px;border-radius:8px;cursor:pointer;}
</style>
</head>

<body>

<header>
<button id="tabAgenda">안건관리</button>
<button id="tabTodo">할일관리</button>
<input class="search" id="search" placeholder="전체 검색">

<button id="backupBtn">백업</button>
<button id="restoreBtn">복원</button>

<!-- GitHub Sync 버튼 -->
<button id="ghPush">업로드</button>
<button id="ghPull">내려받기</button>
<button id="ghTokenReset">토큰초기화</button>

<input type="file" id="fileInput" hidden>
<button id="toggleDark" class="right">다크모드</button>
</header>

<div class="container" id="app"></div>

<!-- 비밀번호 모달 -->
<div id="pwModal">
  <div>
    <div>비밀번호 입력</div>
    <input type="password" id="pwInput" placeholder="비밀번호">
    <div style="display:flex;justify-content:flex-end;gap:8px;">
      <button id="pwSubmit">확인</button>
      <button id="pwCancel">취소</button>
    </div>
  </div>
</div>

<script>
/* ===== 비밀번호 관리 ===== */
const PW_KEY="agenda_pw";
if(!localStorage.getItem(PW_KEY)) localStorage.setItem(PW_KEY,"1234");

function checkPasswordModal(){
  return new Promise((resolve)=>{
    const modal=document.getElementById("pwModal");
    const input=document.getElementById("pwInput");
    const submit=document.getElementById("pwSubmit");
    const cancel=document.getElementById("pwCancel");
    modal.style.display="flex";
    input.value=""; input.focus();

    function cleanup(){
      modal.style.display="none";
      submit.removeEventListener("click",onSubmit);
      cancel.removeEventListener("click",onCancel);
    }
    function onSubmit(){
      if(input.value===localStorage.getItem(PW_KEY)){ cleanup(); resolve(true);}
      else { alert("비밀번호가 틀립니다"); input.value=""; input.focus(); }
    }
    function onCancel(){ cleanup(); resolve(false); }

    submit.addEventListener("click",onSubmit);
    cancel.addEventListener("click",onCancel);
    input.addEventListener("keyup",(e)=>{if(e.key==="Enter") onSubmit();});
  });
}

async function changePassword(){
  const ok = await checkPasswordModal();
  if(!ok) return;
  const newPw=prompt("새 비밀번호 입력");
  if(!newPw) return alert("새 비밀번호를 입력해야 합니다");
  localStorage.setItem(PW_KEY,newPw);
  alert("비밀번호가 변경되었습니다");
}

// 페이지 로드 시 비밀번호 확인
window.addEventListener("load", async ()=>{
  const ok=await checkPasswordModal();
  if(!ok){
    document.body.innerHTML="<h2 style='text-align:center;margin-top:50px'>비밀번호가 틀려 앱에 접근할 수 없습니다</h2>";
    throw new Error("비밀번호 오류");
  }
});

/* ===== 기존 Agenda+Todo 코드 ===== */
// 기존 스크립트는 그대로 유지 (원래 올려주신 전체 코드 붙여넣기)
const storageKey="agendaTodoUltimate";

let data=JSON.parse(localStorage.getItem(storageKey)||`{"agendas":[],"todos":[],"categories":[],"selectedCategory":null,"lastTab":"agenda"}`);
if(!data.categories) data.categories=[];
if(data.selectedCategory===undefined) data.selectedCategory=null;

let editingIndex=null;
let editingTodoIndex=null;
let dragType=null;
let dragIndex=null;

function save(){ localStorage.setItem(storageKey,JSON.stringify(data)) }
function el(tag,cls){ const e=document.createElement(tag); if(cls)e.className=cls; return e }

const app=document.getElementById("app")
const tabAgenda=document.getElementById("tabAgenda")
const tabTodo=document.getElementById("tabTodo")
const searchInput=document.getElementById("search")
const backupBtn=document.getElementById("backupBtn")
const restoreBtn=document.getElementById("restoreBtn")
const fileInput=document.getElementById("fileInput")
const toggleDark=document.getElementById("toggleDark")
const ghPush=document.getElementById("ghPush")
const ghPull=document.getElementById("ghPull")
const ghTokenReset=document.getElementById("ghTokenReset")

// 나머지 기존 코드 그대로
tabAgenda.onclick=()=>setTab("agenda")
tabTodo.onclick=()=>setTab("todo")
function setTab(tab){ data.lastTab=tab; save(); render() }

// ... (기존 render, addTodo, addAgenda 등 모든 코드 그대로) ...

// 비밀번호 변경 버튼 추가
const pwBtn=document.createElement("button")
pwBtn.textContent="비밀번호 변경"
pwBtn.onclick=changePassword
document.querySelector("header").appendChild(pwBtn)

render()
</script>
</body>
</html>
